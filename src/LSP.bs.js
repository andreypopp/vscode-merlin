// Generated by BUCKLESCRIPT, PLEASE EDIT WITH CARE
'use strict';

var Esy = require("./Esy.bs.js");
var $$Node = require("./bindings/Node.bs.js");
var Path = require("path");
var Block = require("bs-platform/lib/js/block.js");
var Curry = require("bs-platform/lib/js/curry.js");
var Utils = require("./Utils.bs.js");
var Vscode = require("./bindings/Vscode.bs.js");
var Vscode$1 = require("vscode");
var Belt_HashMapString = require("bs-platform/lib/js/belt_HashMapString.js");
var Caml_builtin_exceptions = require("bs-platform/lib/js/caml_builtin_exceptions.js");

function detect(folder) {
  return Esy.getStatus(folder).then((function (status) {
                if (status.isProject) {
                  var match = status.rootPackageConfigPath;
                  var manifestFile = (match == null) ? "" : match;
                  if (new RegExp(".json$").test(manifestFile)) {
                    if (status.isProjectReadyForDev) {
                      return Promise.resolve(/* Esy */Block.__(0, [/* readyForDev */true]));
                    } else {
                      return $$Node.Fs.readFile(manifestFile).then((function (manifest) {
                                    var manifestJson = JSON.parse(manifest);
                                    var manifestHasEsyConfig = Utils.propertyExists(manifestJson, "esy");
                                    var manifestIsEsyJSON = new RegExp("esy.json$").test(manifestFile);
                                    if (manifestIsEsyJSON || manifestHasEsyConfig) {
                                      return Promise.resolve(/* Esy */Block.__(0, [/* readyForDev */status.isProjectReadyForDev]));
                                    } else {
                                      var esyToolChainFolder = Path.join(folder, ".vscode", "esy");
                                      return $$Node.Fs.exists(esyToolChainFolder).then((function (doesToolChainEsyManifestExist) {
                                                    if (doesToolChainEsyManifestExist) {
                                                      return Esy.getStatus(esyToolChainFolder).then((function (toolChainStatus) {
                                                                    if (toolChainStatus.isProject) {
                                                                      return Promise.resolve(/* Bsb */Block.__(1, [/* readyForDev */toolChainStatus.isProjectSolved]));
                                                                    } else {
                                                                      return Promise.reject([
                                                                                  Caml_builtin_exceptions.failure,
                                                                                  "Weird invariant violation. Why would .vscode/esy exist but not be a valid esy project. TODO"
                                                                                ]);
                                                                    }
                                                                  }));
                                                    } else {
                                                      return Promise.resolve(/* Bsb */Block.__(1, [/* readyForDev */false]));
                                                    }
                                                  }));
                                    }
                                  }));
                    }
                  } else {
                    return Promise.resolve(/* Opam */0);
                  }
                } else {
                  return Promise.reject([
                              Caml_builtin_exceptions.failure,
                              "Not a valid esy/opam/bsb project"
                            ]);
                }
              }));
}

var ProjectType = {
  detect: detect
};

function make(folder) {
  process.env["OCAMLRUNPARAM"] = "b";
  process.env["MERLIN_LOG"] = "-";
  return detect(folder).then((function (projectType) {
                var setupPromise;
                setupPromise = typeof projectType === "number" ? Promise.resolve(/* () */0) : (
                    projectType.tag ? (
                        projectType[/* readyForDev */0] ? Promise.resolve(/* () */0) : Esy.setup(Path.join(folder, "package.json")).then((function (param) {
                                  return Vscode$1.window.withProgress({
                                              location: 15,
                                              title: "Setting up toolchain..."
                                            }, (function (progress) {
                                                progress.report({
                                                      increment: 10
                                                    });
                                                return $$Node.ChildProcess.exec("esy -P " + Path.join(folder, ".vscode", "esy"), {
                                                              cwd: folder
                                                            }).then((function (param) {
                                                              console.log("Finished running esy");
                                                              return Promise.resolve(/* () */0);
                                                            }));
                                              }));
                                }))
                      ) : (
                        projectType[/* readyForDev */0] ? Promise.resolve(/* () */0) : Vscode$1.window.withProgress({
                                location: 15,
                                title: "Setting up toolchain..."
                              }, (function (progress) {
                                  progress.report({
                                        increment: 10
                                      });
                                  return $$Node.ChildProcess.exec("esy", {
                                                cwd: folder
                                              }).then((function (param) {
                                                console.log("Finished running esy");
                                                return Promise.resolve(/* () */0);
                                              }));
                                }))
                      )
                  );
                return setupPromise.then((function (param) {
                              if (typeof projectType === "number") {
                                if (process.platform === "win32") {
                                  return Promise.reject([
                                              Caml_builtin_exceptions.failure,
                                              "Opam workflow for Windows is not supported yet"
                                            ]);
                                } else {
                                  return Promise.resolve({
                                              command: "opam",
                                              args: /* array */[
                                                "exec",
                                                "ocamlmerlin-lsp"
                                              ],
                                              options: {
                                                env: process.env
                                              }
                                            });
                                }
                              } else if (projectType.tag) {
                                var match = process.platform === "win32";
                                return Promise.resolve({
                                            command: match ? "esy.cmd" : "esy",
                                            args: /* array */[
                                              "-P",
                                              Path.join(folder, ".vscode", "esy"),
                                              "ocamlmerlin-lsp"
                                            ],
                                            options: {
                                              env: process.env
                                            }
                                          });
                              } else {
                                var match$1 = process.platform === "win32";
                                return Promise.resolve({
                                            command: match$1 ? "esy.cmd" : "esy",
                                            args: /* array */[
                                              "exec-command",
                                              "--include-current-env",
                                              "ocamlmerlin-lsp"
                                            ],
                                            options: {
                                              env: process.env
                                            }
                                          });
                              }
                            }));
              }));
}

var Server = {
  make: make
};

function make$1(param) {
  return {
          documentSelector: /* array */[
            {
              scheme: "file",
              language: "ocaml"
            },
            {
              scheme: "file",
              language: "reason"
            }
          ]
        };
}

var Client = {
  make: make$1
};

var LanguageClient = { };

function start(context, commands, createClient) {
  var workspaceFolders = Belt_HashMapString.make(1);
  var startClient = function ($$document) {
    var uri = $$document.uri;
    if (uri.scheme === "file") {
      var folder = Vscode$1.workspace.getWorkspaceFolder(uri);
      if (folder !== undefined) {
        var folder$1 = folder;
        if (Belt_HashMapString.has(workspaceFolders, folder$1.uri.fsPath)) {
          return Promise.resolve(/* () */0);
        } else {
          return Curry._2(createClient, $$document, folder$1).then((function (client) {
                        if (client.tag) {
                          return Vscode$1.window.showErrorMessage("Error: " + (String(client[0]) + ""));
                        } else {
                          var client$1 = client[0];
                          Belt_HashMapString.set(workspaceFolders, Vscode.Folder.key(folder$1), client$1);
                          return Promise.resolve(client$1.start());
                        }
                      }));
        }
      } else {
        return Promise.resolve(/* () */0);
      }
    } else {
      return Promise.resolve(/* () */0);
    }
  };
  Vscode$1.workspace.onDidOpenTextDocument((function ($$document) {
          startClient($$document);
          return /* () */0;
        }));
  var openTasks = Promise.all(Vscode$1.workspace.textDocuments.map(startClient)).then((function (param) {
          return Promise.resolve(/* () */0);
        }));
  Vscode$1.workspace.onDidChangeWorkspaceFolders((function ($$event) {
          $$event.removed.forEach((function (folder) {
                  var match = Belt_HashMapString.get(workspaceFolders, Vscode.Folder.key(folder));
                  if (match !== undefined) {
                    Belt_HashMapString.remove(workspaceFolders, Vscode.Folder.key(folder));
                    return match.stop();
                  } else {
                    return /* () */0;
                  }
                }));
          return /* () */0;
        }));
  commands.forEach((function (param) {
          Vscode$1.commands.registerCommand(param[0], param[1]);
          return /* () */0;
        }));
  context.subscriptions.push({
        dispose: (function () {
            Belt_HashMapString.forEach(workspaceFolders, (function (param, client) {
                    return client.stop();
                  }));
            return Belt_HashMapString.clear(workspaceFolders);
          })
      });
  return openTasks;
}

var MultiWorkspace = {
  FoldersMap: /* alias */0,
  start: start
};

exports.ProjectType = ProjectType;
exports.Server = Server;
exports.Client = Client;
exports.LanguageClient = LanguageClient;
exports.MultiWorkspace = MultiWorkspace;
/* Esy Not a pure module */
